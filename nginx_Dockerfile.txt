FROM smebberson/alpine-nginx-nodejs
MAINTAINER Mikko Korhonen <mikko.korhonen@gmail.com>

ENV YARN_VERSION=0.27.5

# Install yarn
RUN echo -e 'http://dl-cdn.alpinelinux.org/alpine/edge/main\nhttp://dl-cdn.alpinelinux.org/alpine/edge/community\nhttp://dl-cdn.alpinelinux.org/alpine/edge/testing' > /etc/apk/repositories && \
    apk add --no-cache yarn openssl

# Stream the nginx logs to stdout and stderr
RUN ln -sf /dev/stdout /var/log/nginx/access.log && \
    ln -sf /dev/stderr /var/log/nginx/error.log

RUN mkdir -p /tmp
WORKDIR /tmp

# Install dependencies
COPY package.json /tmp/package.json
COPY yarn.lock /tmp/yarn.lock
RUN yarn install --production

# Build
COPY ./ /tmp/
RUN yarn build && \
    cp -a build/. /usr/html && \
    rm -rf /tmp